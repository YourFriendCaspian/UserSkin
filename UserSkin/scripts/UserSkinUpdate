#
[ -e ./userskin.tar.gz ] && rm -rf ./userskin.tar.gz
[ -e ./j00zek-UserSkin-* ] && rm -rf ./j00zek-UserSkin-*
curl --help 1>/dev/null 2>%1
if [ $? -gt 0 ]; then
  echo "Required program 'curl' is not installed. Please install it first."
  exit 0
fi

echo "_(Checking installation mode)..."
if `opkg list-installed 2>/dev/null | tr '[:upper:]' '[:lower:]'| egrep -q 'userskin'`;then
  echo "_(UserSkin controlled by OPKG. Please use it for updates.)"
  exit 0
fi

echo "_(Checking internet connection)..."
ping -c 1 github.com 1>/dev/null 2>%1
if [ $? -gt 0 ]; then
  echo "_(github server unavailable, update impossible)!!!"
  exit 0
fi

echo "_(Downloading latest plugin version)..."
curl -kLs https://api.github.com/repos/j00zek/UserSkin/tarball/master -o /tmp/userskin.tar.gz
if [ $? -gt 0 ]; then
  echo "_(Archive downloaded improperly)"
  exit 0
fi

echo "_(Unpacking new version)..."
cd /tmp
tar -xzf ./userskin.tar.gz
if [ $? -gt 0 ]; then
  echo "_(Archive unpacked improperly)"
  exit 0
fi

if [ ! -e ./j00zek-UserSkin-* ]; then
  echo "_(Archive downloaded improperly)"
  exit 0
fi
rm -rf ./userskin.tar.gz

version=`ls /tmp/ | grep j00zek-UserSkin-`
if [ -f /usr/lib/enigma2/python/Plugins/Extensions/UserSkin/$version ];then
  echo "_(Latest version already installed)"
  exit 0
fi

echo "_(Installing new version)..."
if [ ! -e /DuckboxDisk ]; then #this is our github, we don't update dev
  touch ./$version/UserSkin/$version 2>/dev/null
  cp -a ./j00zek-UserSkin-*/UserSkin/* /usr/lib/enigma2/python/Plugins/Extensions/UserSkin/
else
  echo "github is always up-2-date"
fi

if [ $? -gt 0 ]; then
  echo
  echo "_(Installation incorrect)!!!"
else
  echo
  echo "_(Success: Restart system to use new plugin version)"
fi
exit 0
